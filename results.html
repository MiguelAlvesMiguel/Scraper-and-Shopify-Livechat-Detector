<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scraping Results</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <style>
        .loading {
            text-align: center;
            font-size: 1.5em;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1>Results for "{{ query }}"</h1>
        <div class="loading" id="loading">
            <img src="https://i.gifer.com/ZZ5H.gif" alt="Loading..." width="50" height="50">
            <p>Scraping in progress, please wait...</p>
        </div>
        <table class="table table-bordered" style="display:none;" id="results-table">
            <thead>
                <tr>
                    <th>URL</th>
                    <th>Shopify</th>
                    <th>Email</th>
                    <th>Contact Form</th>
                    <th>Live Chat Solution</th>
                </tr>
            </thead>
            <tbody id="results-table-body">
            </tbody>
        </table>
        <h2 style="display:none;" id="shopify-table-header">Shopify Stores without Live Chat</h2>
        <table class="table table-bordered" style="display:none;" id="shopify-without-livechat-table">
            <thead>
                <tr>
                    <th>URL</th>
                    <th>Email</th>
                    <th>Contact Form</th>
                </tr>
            </thead>
            <tbody id="shopify-without-livechat-table-body">
            </tbody>
        </table>
        <img src="{{ url_for('static', filename='live_chat_usage_pie_chart.png') }}" alt="Live Chat Usage Pie Chart" id="pie-chart" style="display:none;">
        <div class="mt-3" id="download-buttons" style="display:none;">
            <a href="{{ url_for('download_file', filename='lead_report.xlsx') }}" class="btn btn-success">Download All Results</a>
            <a href="{{ url_for('download_file', filename='shopify_without_livechat.xlsx') }}" class="btn btn-warning">Download Shopify Without Live Chat</a>
            <a href="{{ url_for('export') }}" class="btn btn-info">Export Both Tables</a>
        </div>
        <a href="{{ url_for('index') }}">Back to Home</a>
    </div>
    <script>
        function fetchUpdates() {
            $.getJSON("{{ url_for('updates') }}", function(data) {
                var resultsTableBody = $("#results-table-body");
                var shopifyWithoutLivechatTableBody = $("#shopify-without-livechat-table-body");

                resultsTableBody.empty();
                shopifyWithoutLivechatTableBody.empty();

                $.each(data.results_data, function(index, item) {
                    var shopify = item.Shopify ? '✅' : '❌';
                    var liveChat = item["Live Chat Solution"] ? '✅' : '❌';
                    var row = $("<tr>");
                    row.append($("<td>").text(item.URL));
                    row.append($("<td>").html(shopify));
                    row.append($("<td>").text(item.Email || 'N/A'));
                    row.append($("<td>").html(item["Contact Form"] ? `<a href="${item["Contact Form"]}">${item["Contact Form"]}</a>` : 'N/A'));
                    row.append($("<td>").html(liveChat));
                    resultsTableBody.append(row);
                });

                $.each(data.shopify_without_livechat_data, function(index, item) {
                    var row = $("<tr>");
                    row.append($("<td>").text(item.URL));
                    row.append($("<td>").text(item.Email || 'N/A'));
                    row.append($("<td>").html(item["Contact Form"] ? `<a href="${item["Contact Form"]}">${item["Contact Form"]}</a>` : 'N/A'));
                    shopifyWithoutLivechatTableBody.append(row);
                });

                if (data.results_data.length > 0) {
                    $("#results-table").show();
                    $("#shopify-table-header").show();
                    $("#shopify-without-livechat-table").show();
                    $("#pie-chart").show();
                    $("#download-buttons").show();
                    $("#loading").hide();
                }
            });
        }

        fetchUpdates();
        setInterval(fetchUpdates, 3000);
    </script>
</body>
</html>
